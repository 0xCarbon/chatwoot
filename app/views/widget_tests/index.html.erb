<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />

<button id="reset-and-reload">Reset conversation and reload</button>

<%
  user_id = 1
  user_hash = OpenSSL::HMAC.hexdigest(
    'sha256',
    @web_widget.hmac_token,
    user_id.to_s
  )

%>
<script>

function deleteAllCookies() {
  if (window.cookieStore) {
    cookieStore.getAll().then(cookies => cookies.forEach(cookie => {
      console.log('Cookie deleted:', cookie);
      cookieStore.delete(cookie.name);
    }));
  } else {
    // for safari and firefox: https://caniuse.com/cookie-store-api
    // TODO: Remove this once this is widely supported
    const cookies = document.cookie.split(";");

    cookies.forEach(cookie => {
      const eqPos = cookie.indexOf("=");
      const name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
      document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT";
    });
  }
}

document.getElementById('reset-and-reload').addEventListener('click', function() {
  deleteAllCookies();
  window.location.reload();
});

window.chatwootSettings = {
  hideMessageBubble: false,
  position: '<%= @widget_position %>',
  locale: 'en',
  useBrowserLanguage: true,
  type: '<%= @widget_type %>',
  showPopoutButton: true,
  widgetStyle: '<%= @widget_style %>',
  darkMode: '<%= @dark_mode %>',
};

(function(d,t) {
  var BASE_URL = '';
  var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
  g.src= BASE_URL + "/packs/js/sdk.js";
  g.defer = true;
  g.async = true;
  s.parentNode.insertBefore(g,s);
  g.onload=function(){
    window.chatwootSDK.run({
      websiteToken: '<%= @web_widget.website_token %>',
      baseUrl: BASE_URL
    })
  }
})(document,"script");

window.addEventListener('chatwoot:ready', function() {
  console.log('chatwoot:ready', window.$chatwoot);
  if (window.location.search.includes('setUser')) {
    window.$chatwoot.setUser('<%= user_id %>', {
      identifier_hash: '<%= user_hash %>',
      email: 'jane@example.com',
      name: 'Jane Doe',
      phone_number: ''
    });
  }
})

window.addEventListener('chatwoot:error', function(e) {
  console.log('chatwoot:error', e.detail)
})


window.addEventListener('chatwoot:on-message', function(e) {
  console.log('chatwoot:on-message', e.detail)
})
</script>
